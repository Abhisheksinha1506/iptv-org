# Database Tables and Required Information

This document outlines all database tables required for the IPTV Fusion Hub application and the information each table stores.

## Overview

The application requires **5 MANDATORY tables** to function:
1. `channels` - **MANDATORY** - Core table for all channel data
2. `repositories` - **MANDATORY** - Required for automated updates
3. `test_results` - **MANDATORY** - Required for quality tracking
4. `quality_metrics` - **MANDATORY** - Required for quality scoring
5. `repository_updates` - **MANDATORY** - Required for audit trail

**All tables are now mandatory** - the application will fail to start or run cron jobs if any table is missing.

---

## 1. `channels` Table ⭐ **MANDATORY**

**Purpose**: Stores all IPTV channel information. This is the core table that the application cannot function without.

### Required Fields (NOT NULL):
- `id` (TEXT, PRIMARY KEY)
  - **Format**: `chn_` + 16-character SHA-1 hash of URL
  - **Example**: `chn_a1b2c3d4e5f6g7h8`
  - **Generated by**: Application (from channel URL)

- `name` (TEXT, NOT NULL)
  - **Description**: Channel name/display name
  - **Example**: "CNN International", "BBC One", "ESPN"
  - **Source**: Extracted from M3U `#EXTINF:` line

- `url` (TEXT, NOT NULL)
  - **Description**: Stream URL (HTTP/HTTPS)
  - **Example**: `http://example.com/stream.m3u8`
  - **Source**: M3U playlist file

- `country` (TEXT, NOT NULL)
  - **Description**: ISO 2-letter country code (uppercase)
  - **Example**: `US`, `GB`, `FR`, `DE`
  - **Default**: `unknown` if not specified
  - **Source**: M3U `tvg-country` attribute or inferred from file path

- `category` (TEXT, NOT NULL)
  - **Description**: Channel category (lowercase)
  - **Examples**: `news`, `sports`, `movies`, `music`, `kids`, `general`
  - **Default**: `general` if not specified
  - **Source**: M3U `group-title` attribute or inferred from channel name

- `status` (TEXT, NOT NULL)
  - **Description**: Stream status
  - **Values**: `'active'`, `'inactive'`, `'untested'`
  - **Default**: `'untested'` for new channels
  - **Updated by**: Stream testing process

- `source` (TEXT, NOT NULL)
  - **Description**: Repository/source identifier
  - **Example**: `herberthe-iptv-sources`, `iptv-org-iptv`
  - **Source**: Repository ID from `repositories` table

### Optional Fields (NULLABLE):
- `logo` (TEXT, NULL)
  - **Description**: Channel logo URL
  - **Example**: `https://example.com/logo.png`
  - **Source**: M3U `tvg-logo` attribute

- `tvg_id` (TEXT, NULL)
  - **Description**: EPG/XMLTV channel ID
  - **Source**: M3U `tvg-id` attribute

- `tvg_name` (TEXT, NULL)
  - **Description**: EPG channel name
  - **Source**: M3U `tvg-name` attribute

- `quality_score` (INTEGER, DEFAULT 0)
  - **Description**: Quality score (0-100)
  - **Default**: `0`
  - **Updated by**: Quality metrics calculation

- `last_tested` (TIMESTAMP, NULL)
  - **Description**: Last test timestamp
  - **Updated by**: Stream testing process

- `created_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Record creation timestamp
  - **Auto-generated**: Yes

- `updated_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Last update timestamp
  - **Auto-updated**: Yes (via trigger)

### Indexes:
- `idx_channels_source` - For filtering by source
- `idx_channels_status` - For filtering by status
- `idx_channels_category` - For filtering by category
- `idx_channels_country` - For filtering by country
- `idx_channels_quality_score` - For sorting by quality

---

## 2. `repositories` Table ⭐ **MANDATORY**

**Purpose**: Tracks GitHub repositories that contain IPTV channel lists. Required for the automated update system to function.

### Required Fields (NOT NULL):
- `id` (TEXT, PRIMARY KEY)
  - **Description**: Unique repository identifier
  - **Example**: `herberthe-iptv-sources`, `iptv-org-iptv`
  - **Source**: Configuration file or manual entry

- `owner` (TEXT, NOT NULL)
  - **Description**: GitHub repository owner/username
  - **Example**: `HerbertHe`, `iptv-org`
  - **Source**: Configuration file

- `repo` (TEXT, NOT NULL)
  - **Description**: GitHub repository name
  - **Example**: `iptv-sources`, `iptv`
  - **Source**: Configuration file

- `branch` (TEXT, NOT NULL)
  - **Description**: Git branch to track
  - **Example**: `main`, `master`
  - **Source**: Configuration file

- `paths` (JSONB, NOT NULL)
  - **Description**: Array of file/directory paths to monitor
  - **Format**: JSON array of strings
  - **Example**: `["README.md", "public/"]` or `["streams/"]`
  - **Source**: Configuration file

### Optional Fields (NULLABLE):
- `last_commit_sha` (TEXT, NULL)
  - **Description**: Last known commit SHA
  - **Purpose**: Used to detect repository updates
  - **Updated by**: Repository check process

- `last_checked` (TIMESTAMP, NULL)
  - **Description**: Last time repository was checked
  - **Updated by**: Repository check process

- `created_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Record creation timestamp
  - **Auto-generated**: Yes

- `updated_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Last update timestamp
  - **Auto-updated**: Yes (via trigger)

### Minimum Data Required:
At least one repository record must exist for the automated update system to work. The application can initialize repositories from `src/config/source-repositories.json` if the table is empty.

---

## 3. `test_results` Table ⭐ **MANDATORY**

**Purpose**: Stores individual stream test results. **MANDATORY** for quality tracking and metrics calculation.

### Required Fields (NOT NULL):
- `id` (UUID, PRIMARY KEY)
  - **Description**: Unique test result identifier
  - **Auto-generated**: Yes (via `gen_random_uuid()`)

- `channel_id` (TEXT, NOT NULL, FOREIGN KEY → `channels.id`)
  - **Description**: Reference to the tested channel
  - **Cascade**: Deletes when channel is deleted

- `status` (TEXT, NOT NULL)
  - **Description**: Test result status
  - **Values**: `'success'`, `'failure'`
  - **Source**: Stream testing process

- `response_time_ms` (INTEGER, NOT NULL)
  - **Description**: Response time in milliseconds
  - **Example**: `1250`, `5000`
  - **Source**: Stream testing process

- `bitrate_kbps` (INTEGER, NOT NULL)
  - **Description**: Stream bitrate in kilobits per second
  - **Example**: `2500`, `5000`, `0` (if unknown)
  - **Source**: Parsed from M3U8 playlist or estimated

- `resolution` (TEXT, NOT NULL)
  - **Description**: Video resolution
  - **Example**: `1920x1080`, `1280x720`, `unknown`
  - **Source**: Parsed from M3U8 playlist or estimated

- `tested_at` (TIMESTAMP, NOT NULL)
  - **Description**: Test execution timestamp
  - **Source**: Stream testing process

- `region` (TEXT, NOT NULL)
  - **Description**: Testing region/location
  - **Example**: `local`, `us-east`, `eu-west`
  - **Default**: `local`
  - **Source**: Stream testing process

- `created_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Record creation timestamp
  - **Auto-generated**: Yes

### Indexes:
- `idx_test_results_channel_id` - For fetching test history per channel
- `idx_test_results_tested_at` - For sorting by test date

### Minimum Data Required:
Table must exist (can be empty initially). Test results are automatically created when streams are tested.

---

## 4. `quality_metrics` Table ⭐ **MANDATORY**

**Purpose**: Stores calculated quality metrics for each channel. **MANDATORY** for quality scoring and dashboard display.

### Required Fields (NOT NULL):
- `channel_id` (TEXT, PRIMARY KEY, FOREIGN KEY → `channels.id`)
  - **Description**: Reference to the channel
  - **Cascade**: Deletes when channel is deleted

- `uptime_percentage` (NUMERIC, NOT NULL)
  - **Description**: Percentage of successful tests (0-100)
  - **Example**: `85.5`, `100.0`, `0.0`
  - **Calculated from**: `test_results` table

- `stability_score` (NUMERIC, NOT NULL)
  - **Description**: Stability score based on bitrate (0-100)
  - **Example**: `75.0`, `50.0`
  - **Calculated from**: Average bitrate in `test_results`

- `video_quality_score` (NUMERIC, NOT NULL)
  - **Description**: Video quality score based on resolution (0-100)
  - **Example**: `100.0` (1080p), `67.0` (720p)
  - **Calculated from**: Resolution in `test_results`

- `geo_availability_score` (NUMERIC, NOT NULL)
  - **Description**: Geographic availability score (0-100)
  - **Example**: `100.0` (3+ regions), `33.0` (1 region)
  - **Calculated from**: Number of unique regions in `test_results`

- `overall_score` (INTEGER, NOT NULL)
  - **Description**: Weighted overall quality score (0-100)
  - **Formula**: 
    - 40% uptime + 25% stability + 20% video quality + 15% geo availability
  - **Example**: `85`, `72`, `45`

- `calculated_at` (TIMESTAMP, NOT NULL)
  - **Description**: When metrics were calculated
  - **Source**: Metrics calculation process

- `updated_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Last update timestamp
  - **Auto-updated**: Yes (via trigger)

### Minimum Data Required:
Table must exist (can be empty initially). Quality metrics are automatically calculated and saved when streams are tested.

---

## 5. `repository_updates` Table ⭐ **MANDATORY**

**Purpose**: Audit log of repository update operations. **MANDATORY** for tracking changes, debugging, and maintaining update history.

### Required Fields (NOT NULL):
- `id` (UUID, PRIMARY KEY)
  - **Description**: Unique update record identifier
  - **Auto-generated**: Yes (via `gen_random_uuid()`)

- `repository` (TEXT, NOT NULL)
  - **Description**: Repository identifier
  - **Example**: `herberthe-iptv-sources`
  - **Source**: Repository processing

- `timestamp` (TIMESTAMP, NOT NULL)
  - **Description**: Update timestamp
  - **Source**: Repository processing

- `message` (TEXT, NOT NULL)
  - **Description**: Update description
  - **Example**: `"Processed 150 channels"`
  - **Source**: Repository processing

- `channels_added` (INTEGER, NOT NULL, DEFAULT 0)
  - **Description**: Number of channels added
  - **Source**: Channel comparison process

- `channels_updated` (INTEGER, NOT NULL, DEFAULT 0)
  - **Description**: Number of channels updated
  - **Source**: Channel comparison process

- `channels_removed` (INTEGER, NOT NULL, DEFAULT 0)
  - **Description**: Number of channels removed
  - **Source**: Channel comparison process

- `processed` (BOOLEAN, DEFAULT FALSE)
  - **Description**: Whether update has been processed
  - **Default**: `false`
  - **Purpose**: For queue management (future use)

- `created_at` (TIMESTAMP, DEFAULT NOW())
  - **Description**: Record creation timestamp
  - **Auto-generated**: Yes

### Indexes:
- `idx_repository_updates_processed` - For filtering unprocessed updates
- `idx_repository_updates_timestamp` - For sorting by timestamp

### Minimum Data Required:
Table must exist (can be empty initially). Update records are automatically created when repositories are processed.

---

## Database Functions and Triggers

### Function: `update_updated_at_column()`
- **Purpose**: Automatically updates `updated_at` timestamp
- **Used by**: Triggers on `channels`, `repositories`, `quality_metrics`

### Triggers:
1. `update_channels_updated_at` - Auto-updates `channels.updated_at`
2. `update_repositories_updated_at` - Auto-updates `repositories.updated_at`
3. `update_quality_metrics_updated_at` - Auto-updates `quality_metrics.updated_at`

---

## Minimum Requirements for Application to Function

### ✅ **ALL TABLES ARE MANDATORY:**
1. **`repositories` table** - Must exist (can be empty initially, will auto-initialize from config)
2. **`channels` table** - Must exist (can be empty initially, populated by cron jobs)
3. **`test_results` table** - Must exist (can be empty initially, populated by stream testing)
4. **`quality_metrics` table** - Must exist (can be empty initially, populated by metrics calculation)
5. **`repository_updates` table** - Must exist (can be empty initially, populated by update operations)

### Application Behavior:
- **All cron jobs validate tables exist** before running
- **Missing tables will cause errors** with clear error messages
- **Tables can be empty initially** - data is populated automatically
- **Migration must be run** before application can function properly

### Minimum Data Requirements:
- **For basic operation**: All 5 tables must exist (can be empty)
- **For automated updates**: At least one repository record (or config file for auto-initialization)
- **For quality features**: Test results and quality metrics are automatically created when streams are tested

---

## Table Relationships

```
repositories (1) ──┐
                   │
                   ├──> channels (many)
                   │      │
                   │      ├──> test_results (many)
                   │      │
                   │      └──> quality_metrics (1)
                   │
repository_updates (many) ──┘
```

### Foreign Key Constraints:
- `test_results.channel_id` → `channels.id` (ON DELETE CASCADE)
- `quality_metrics.channel_id` → `channels.id` (ON DELETE CASCADE)
- `repository_updates.repository` → `repositories.id` (no FK constraint, but references it)

---

## Data Flow

1. **Repository Setup**:
   - Repository records created in `repositories` table
   - Initialized from config file or manually

2. **Channel Ingestion**:
   - M3U files fetched from repositories
   - Parsed and saved to `channels` table
   - Update record created in `repository_updates` table

3. **Stream Testing**:
   - Channels tested and results saved to `test_results` table
   - Channel status updated in `channels` table

4. **Quality Calculation**:
   - Metrics calculated from `test_results`
   - Saved to `quality_metrics` table
   - Overall score updated in `channels.quality_score`

---

## Example Minimum Viable Data

### To get started, you need at minimum:

**1. One repository record:**
```sql
INSERT INTO repositories (id, owner, repo, branch, paths)
VALUES (
  'iptv-org-iptv',
  'iptv-org',
  'iptv',
  'master',
  '["streams/"]'::jsonb
);
```

**2. Channels will be automatically populated** when the cron job runs or when you manually trigger an update.

**3. Test results and metrics** will be populated when stream testing runs.

---

## Notes

- All tables use `IF NOT EXISTS` in the schema, so they can be created safely
- Foreign key constraints ensure data integrity
- Cascade deletes prevent orphaned records
- Indexes optimize query performance for filtering and sorting
- Timestamps are automatically managed via triggers and defaults

